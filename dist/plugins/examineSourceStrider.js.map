{"version":3,"sources":["../../lib/plugins/examineSourceStrider.js"],"names":[],"mappings":"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","file":"examineSourceStrider.js","sourcesContent":["var yaml = require('js-yaml')\nvar fs = require('fs')\nvar Wreck = require('wreck')\nvar config = require('config')\nvar logger = require('../util/log.js')(module)\nvar tmpDir = require('../util/tmpDir.js')\n\nvar wreck = Wreck.defaults({\n  json: true\n})\n\nvar token = config.droneToken\n\nmodule.exports = function (emitter) {\n  installIntoWorkflow(emitter)\n  emitter.on('workflow.registeredEvent.examineSource.download.strider', examineSourceStrider)\n\n  function examineSourceStrider (job, cb) {\n    var workDirectory = tmpDir({prefix: 'drone-examineSource-'}, job.id)\n\n    if (job.trigger === 'github') {\n      var doc = null\n      if (fs.existsSync(workDirectory)) {\n        try {\n          doc = yaml.safeLoad(fs.readFileSync(workDirectory + '/.strider.yml', 'utf8'))\n        } catch (e) {\n          logger.warn('Failed to load .strider.yml!', e)\n        }\n      }\n      if (!doc) {\n        job.status = 'aborted'\n        job.result = 'failed'\n        wreck.post(config.coreUrl + '/api/v1/jobs', {\n           payload: JSON.stringify(job),\n          'headers': {'authorization': token}\n        }, function (err, res, payload) {\n          if (err) console.error('failed to submit a job after not loading doc', err)\n          cb(null, job)\n        })\n        return\n      }\n\n      if (doc.hasOwnProperty('env')) {\n        if (doc.env.length > 1) {\n          // Matrix build\n          var childNo = 1\n          doc.os.forEach(function (os, osindex, osarray) {\n            doc.env.forEach(function (elem, index, array) {\n              var childJob = clone(job)\n              childJob._id = undefined\n              childJob.requiredResource = os\n              childJob.allowedToFail = checkAllowedToFail(doc, os)\n              childJob.parent = job.id\n              childJob.childNo = childNo\n              childJob.children = {}\n              childJob.status = 'received'\n              childJob.result = 'pending'\n              childJob.trigger = 'rest'\n              childJob.stdout = {}\n              childJob.stderr = {}\n              childJob.triggerInfo.cmds = []\n              if (doc.hasOwnProperty('before_install')) childJob.triggerInfo.cmds = childJob.triggerInfo.cmds.concat(doc.before_install)\n              if (doc.hasOwnProperty('install')) childJob.triggerInfo.cmds = childJob.triggerInfo.cmds.concat(doc.install)\n              if (doc.hasOwnProperty('script')) childJob.triggerInfo.cmds = childJob.triggerInfo.cmds.concat(doc.script)\n              childJob.triggerInfo.cmdsEnv = elem + ' TRAVIS_PULL_REQUEST=' + job.triggerInfo.data.number\n              delete childJob['meta']\n              delete childJob['$loki']\n              delete childJob['id']\n              childNo++\n              wreck.post(config.coreUrl + '/api/v1/jobs', {\n                payload: JSON.stringify(childJob),\n                'headers': {'authorization': token}\n              }, function (err, res, payload) {\n                if (err) logger.warn('failed to submit a child job', childJob)\n              })\n            })\n          })\n        }\n      }\n    }\n    if (job.trigger === 'rest') {\n      // nothing to do here\n    }\n    cb(null, job)\n  }\n}\n\nfunction checkAllowedToFail (doc, os) {\n  var allowedToFail = doc['allowed_to_fail']\n  if (allowedToFail) return allowedToFail.indexOf(os) > -1\n  return false\n}\n\nfunction installIntoWorkflow (emitter) {\n  emitter.emit('workflow.registeredEvent.install',\n    'job.new',\n    'workflow.registeredEvent.examineSource.download.strider',\n    110,\n    function (err, res) {\n      logger.debug('installIntoWorkflow failed', err)\n    })\n  emitter.on('auth.token', function (newToken) {\n    token = newToken\n  })\n}\n\nfunction clone (a) {\n  return JSON.parse(JSON.stringify(a))\n}\n"]}