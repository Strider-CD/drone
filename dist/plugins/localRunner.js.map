{"version":3,"sources":["../../lib/plugins/localRunner.js"],"names":[],"mappings":"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","file":"localRunner.js","sourcesContent":["var async = require('async')\nvar StreamSplitter = require('stream-splitter')\nvar Wreck = require('wreck')\nvar shell = require('shelljs')\nvar config = require('config')\nvar exec = require('child_process').exec\nvar logger = require('../util/log.js')(module)\n\nvar wreck = Wreck.defaults({\n  json: true\n})\n\nvar token = config.droneToken\n\nmodule.exports = function (emitter, client) {\n  installIntoWorkflow(emitter)\n  emitter.on('workflow.registeredEvent.runner.local', localRunner)\n\n  var lineNumber = 1\n  var stdout = {}\n  var stderr = {}\n\n  function localRunner (job, cb) {\n    lineNumber = 1\n    stdout = {}\n    stderr = {}\n    workDirectory = null\n\n    if (!job.triggerInfo.hasOwnProperty('cmds')) {\n      cb(null, job) // nothing to do here\n      return\n    }\n    var execEnv = ''\n    if (job.triggerInfo.hasOwnProperty('cmdsEnv')) {\n      var envArray = job.triggerInfo.cmdsEnv.split(' ')\n      var entry = null\n      envArray.forEach(function (elem, index, array) {\n        entry = elem.split('=')\n        if (entry.length === 2) {\n          process.env[entry[0]] = entry[1]\n        }\n      })\n    }\n    var workDirectory = tmpDir({prefix: 'drone-build-'}, job.id)\n    shell.mkdir('-p', workDirectory)\n\n    var cloneUrl = 'https://github.com/' + job.triggerInfo.data.branchBase\n    var cloneCmd = 'git clone --depth 50 ' + cloneUrl + ' .' // shallow clone (truncate history)\n\n    var fetchCmd = 'git fetch origin +' + job.triggerInfo.data.fetch + ':'\n    var fetchHeadCmd = 'git checkout -qf FETCH_HEAD'\n\n    var cmds = [cloneCmd, fetchCmd, fetchHeadCmd].concat(job.triggerInfo.cmds)\n    var cmdList = cmds.join(' && ')\n    cmds = [execEnv + ' /bin/bash -c ' + \"'\" + cmdList + \"'\"]\n    cmds = cmds.map(function (cmd) {\n      return function (callback) {\n        runCmd(cmd, job, workDirectory, callback)\n      }\n    })\n    logger.info('job.id ' + job.id + ' will run cmds')\n    async.series(cmds, function (err, res) {\n      if (err) {\n        if (err.hasOwnProperty('canceled')) {\n          job.status = 'aborted'\n          job.result = 'failed'\n        } else if (err.hasOwnProperty('failed')) {\n          job.status = 'finished'\n          job.result = 'failed'\n        }\n      } else {\n        job.status = 'finished'\n        job.result = 'success'\n      }\n      job.stdout = stdout\n      job.stderr = stderr\n      logger.info('job.id ' + job.id + ' finished with status: ' + job.result)\n      // client.write({room: job.id, 'msg': { type: 'control', save: true, 'returnCode': returnCode }})\n      client.write({room: job.id, type: 'leave', msg: {}})\n      shell.rm('-rf', workDirectory)\n      wreck.put(config.coreUrl + '/api/v1/jobs/id/' + job.id, {\n        payload: JSON.stringify(job),\n        'headers': {'authorization': token}\n      }, function (err, res, payload) {\n        if (res.statusCode !== 200) {\n          logger.warn('failed to upload updated job to core')\n        }\n        if (err) {\n          logger.warn('failed to upload updated job to core', err)\n          return\n        }\n        cb(null, job)\n      })\n    })\n  }\n\n  function runCmd (cmd, job, workDirectory, callback) {\n    client.write({room: job.id, type: 'join', msg: {}})\n    var child = exec(cmd, {cwd: workDirectory, maxBuffer: 500 * 1024})\n\n    var splitStreamStdout = child.stdout.pipe(StreamSplitter('\\n'))\n    var splitStreamStderr = child.stderr.pipe(StreamSplitter('\\n'))\n\n    splitStreamStdout.on('token', function (lineStream) {\n      var line = lineStream.toString()\n      logger.info(line)\n      stdout[lineNumber] = line\n      client.write({\n        'room': job.id,\n        'type': 'stdout',\n        'msg': {\n          'line': line,\n          'lineNumber': lineNumber\n        }\n      })\n      lineNumber++\n    })\n\n    splitStreamStderr.on('token', function (lineStream) {\n      var line = lineStream.toString()\n      logger.info(line)\n      stderr[lineNumber] = line\n      client.write({\n        'room': job.id,\n        'type': 'stderr',\n        'msg': {\n          'line': line,\n          'lineNumber': lineNumber\n        }\n      })\n      lineNumber++\n    })\n\n    child.on('exit', function (returnCode) {\n      if (!returnCode) {\n        callback(null, null) // zero return value -> success\n      } else {\n        callback({failed: true}, null) // non-zero return value -> cmd failed\n      }\n    })\n  }\n}\n\nfunction installIntoWorkflow (emitter) {\n  emitter.emit('workflow.registeredEvent.install',\n    'job.new',\n    'workflow.registeredEvent.runner.local',\n    400,\n    function (err, res) {\n      logger.debug('installIntoWorkflow failed', err)\n    })\n  emitter.on('auth.token', function (newToken) {\n    token = newToken\n  })\n}\n\nfunction tmpDir (config, name) {\n  var dirName = ''\n  if (config.hasOwnProperty('baseDir')) {\n    dirName = config.baseDir\n  } else {\n    dirName = '/tmp'\n  }\n  if (config.hasOwnProperty('prefix')) {\n    dirName = '/tmp/' + config.prefix + name\n  } else {\n    dirName = '/tmp/' + name\n  }\n  return dirName\n}\n"]}