{"version":3,"sources":["../../lib/job-sources/corePoller.js"],"names":[],"mappings":";;AAAA,IAAI,QAAQ,QAAQ,OAAR,CAAZ;AACA,IAAI,SAAS,QAAQ,aAAR,EAAuB,MAAvB,CAAb;AACA,IAAI,SAAS,QAAQ,QAAR,CAAb;;AAEA,IAAI,kBAAkB,MAAtB;AACA,IAAI,QAAQ,MAAM,QAAN,CAAe;AACzB,QAAM;AADmB,CAAf,CAAZ;;AAIA,IAAI,QAAQ,OAAO,UAAnB;;AAEA,SAAS,SAAT,CAAoB,OAApB,EAA6B;AAC3B,MAAI,oBAAoB,QAAxB,EAAkC;AAChC;AACD;;AAED,MAAI,UAAU;AACZ,aAAS,EAAC,eAAe,KAAhB,EADG;AAEZ,aAAS,IAFG,EAEM;AAClB,cAAU,OAHE,EAGO;AACnB,aAAS,KAAK,SAAL,CAAe,EAAC,kBAAkB,QAAQ,QAA3B,EAAf;AAJG,GAAd;;AAOA,SAAO,IAAP,CAAY,yBAAZ;;AAEA,QAAM,IAAN,CAAW,OAAO,OAAP,GAAiB,uBAA5B,EAAqD,OAArD,EAA8D,UAAU,GAAV,EAAe,GAAf,EAAoB,GAApB,EAAyB;AACrF,QAAI,GAAJ,EAAS;AACT,QAAI,IAAI,UAAJ,KAAmB,GAAvB,EAA4B;AAC5B,QAAI,IAAI,OAAJ,CAAY,gBAAZ,MAAkC,CAAtC,EAAyC;;AAEzC,sBAAkB,QAAlB;AACA,WAAO,IAAP,CAAY,aAAZ,EAA2B,GAA3B;;AAEA,YAAQ,IAAR,CAAa,6BAAb,EAA4C,GAA5C,EAAiD,UAAU,GAAV,EAAe,GAAf,EAAoB;AACnE,UAAI,GAAJ,EAAS;AACP,eAAO,IAAP,CAAY,0CAAZ,EAAwD,GAAxD;AACA;AACD;AACF,KALD;AAMD,GAdD;AAeD;;AAED,OAAO,OAAP,GAAiB,UAAU,OAAV,EAAmB;AAClC,sBAAoB,OAApB;;AAEA,UAAQ,EAAR,CAAW,sCAAX,EAAmD,UAAU,GAAV,EAAe,EAAf,EAAmB;AACpE,sBAAkB,MAAlB;AACA,OAAG,IAAH,EAAS,GAAT;AACD,GAHD;;AAKA,UAAQ,EAAR,CAAW,YAAX,EAAyB,UAAU,QAAV,EAAoB;AAC3C,YAAQ,QAAR;AACD,GAFD;;AAIA,cAAY,MAAM,UAAU,OAAV,CAAlB,EAAsC,OAAO,eAA7C;AACD,CAbD;;AAeA,SAAS,mBAAT,CAA8B,OAA9B,EAAuC;AACrC,UAAQ,IAAR,CAAa,kCAAb,EAAiD;AAC/C,YAAQ,SADuC;AAE/C,qBAAiB,sCAF8B;AAG/C,cAAU;AAHqC,GAAjD,EAIG,UAAU,GAAV,EAAe,GAAf,EAAoB;AACrB,QAAI,GAAJ,EAAS;AACP,aAAO,KAAP,CAAa,6BAAb,EAA4C,GAA5C;AACD;AACF,GARD;AASD","file":"corePoller.js","sourcesContent":["var Wreck = require('wreck')\nvar logger = require('../util/log')(module)\nvar config = require('config')\n\nvar jobRunnerStatus = 'done'\nvar wreck = Wreck.defaults({\n  json: true\n})\n\nvar token = config.droneToken\n\nfunction getNewJob (emitter) {\n  if (jobRunnerStatus === 'active') {\n    return\n  }\n\n  var options = {\n    headers: {authorization: token},\n    timeout: 1000,    // 1 second, default: unlimited\n    maxBytes: 1048576, // 1 MB, default: unlimited\n    payload: JSON.stringify({requiredResource: process.platform})\n  }\n\n  logger.info('asking core for new job')\n\n  wreck.post(config.coreUrl + '/api/v1/jobs/retrieve', options, function (err, res, job) {\n    if (err) return\n    if (res.statusCode !== 200) return\n    if (res.headers['content-length'] === 0) return\n\n    jobRunnerStatus = 'active'\n    logger.info('got new job', job)\n\n    emitter.emit('workflow.baseEvents.job.new', job, function (err, res) {\n      if (err) {\n        logger.warn('something went wrong whilst processing: ', job)\n        // TODO: notify core that this job failed (re-insert into queue?)\n      }\n    })\n  })\n}\n\nmodule.exports = function (emitter) {\n  installIntoWorkflow(emitter)\n\n  emitter.on('workflow.registeredEvent.core.poller', function (job, cb) {\n    jobRunnerStatus = 'done'\n    cb(null, job)\n  })\n\n  emitter.on('auth.token', function (newToken) {\n    token = newToken\n  })\n\n  setInterval(() => getNewJob(emitter), config.pollingInterval)\n}\n\nfunction installIntoWorkflow (emitter) {\n  emitter.emit('workflow.registeredEvent.install', {\n    domain: 'job.new',\n    registeredEvent: 'workflow.registeredEvent.core.poller',\n    priority: 1000\n  }, function (err, res) {\n    if (err) {\n      logger.debug('installIntoWorkflow failed!', err)\n    }\n  })\n}\n"]}