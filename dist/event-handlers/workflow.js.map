{"version":3,"sources":["../../lib/event-handlers/workflow.js"],"names":[],"mappings":";;AAAA,MAAM,SAAS,QAAQ,QAAR,CAAf;AACA,MAAM,QAAQ,QAAQ,OAAR,CAAd;AACA,MAAM,SAAS,QAAQ,aAAR,EAAuB,MAAvB,CAAf;;AAEA,IAAI,mBAAmB;AACrB,aAAW,EADU;AAErB,cAAY,EAFS;AAGrB,sBAAoB;AAHC,CAAvB;;AAMA,OAAO,OAAP,GAAiB,UAAU,OAAV,EAAmB;AAClC,UAAQ,EAAR,CAAW,6BAAX,EAA0C,gBAA1C;AACA,UAAQ,EAAR,CAAW,8BAAX,EAA2C,iBAA3C;AACA,UAAQ,EAAR,CAAW,sCAAX,EAAmD,wBAAnD;AACA,UAAQ,EAAR,CAAW,kCAAX,EAA+C,sBAA/C;AACA,UAAQ,EAAR,CAAW,+BAAX,EAA4C,sBAA5C;AACA,UAAQ,EAAR,CAAW,gCAAX,EAA6C,oBAA7C;;AAEA,WAAS,gBAAT,CAA2B,GAA3B,EAAgC,EAAhC,EAAoC;AAClC,yBAAqB,SAArB,EAAgC,GAAhC,EAAqC,EAArC;AACD;;AAED,WAAS,iBAAT,CAA4B,GAA5B,EAAiC,EAAjC,EAAqC;AACnC,yBAAqB,UAArB,EAAiC,GAAjC,EAAsC,EAAtC;AACD;;AAED,WAAS,wBAAT,CAAmC,GAAnC,EAAwC,EAAxC,EAA4C;AAC1C,yBAAqB,kBAArB,EAAyC,EAAzC;AACD;;AAED,WAAS,sBAAT,CAAiC,EAAC,MAAD,EAAS,eAAT,EAA0B,QAA1B,EAAjC,EAAsE,EAAtE,EAA0E;AACxE,QAAI,CAAC,iBAAiB,cAAjB,CAAgC,MAAhC,CAAL,EAA8C;AAC5C,uBAAiB,MAAjB,IAA2B,EAA3B;AACD;AACD,QAAI,iBAAiB,MAAjB,EAAyB,MAAzB,KAAoC,CAAxC,EAA2C;AACzC,UAAI,WAAW;AACb,kBAAU;AADG,OAAf;AAGA,uBAAiB,MAAjB,EAAyB,IAAzB,CAA8B,QAA9B;AACD;AACD,qBAAiB,MAAjB,EAAyB,IAAzB,CAA8B;AAC5B,cAD4B;AAE5B;AAF4B,KAA9B;AAIA,qBAAiB,MAAjB,IAA2B,OAAO,MAAP,CAAc,iBAAiB,MAAjB,CAAd,EAAwC,SAAxC,CAA3B;;AAEA,OAAG,IAAH,EAAS,IAAT;AACD;;AAED,WAAS,oBAAT,CAA+B,MAA/B,EAAuC,GAAvC,EAA4C,EAA5C,EAAgD;AAC9C,QAAI,iBAAiB,cAAjB,CAAgC,MAAhC,CAAJ,EAA6C;AAC3C,uBAAiB,MAAjB,IAA2B,OAAO,MAAP,CAAc,iBAAiB,MAAjB,CAAd,EAAwC,SAAxC,CAA3B;AACA,YAAM,SAAN,CAAgB,iBAAiB,MAAjB,EAAyB,GAAzB,CAA6B,UAAU,IAAV,EAAgB;AAC3D,YAAI,KAAK,QAAL,KAAkB,CAAtB,EAAyB;AACvB,iBAAO,UAAU,QAAV,EAAoB;AACzB,qBAAS,IAAT,EAAe,GAAf;AACD,WAFD;AAGD,SAJD,MAIO;AACL,iBAAO,UAAU,GAAV,EAAe,QAAf,EAAyB;AAC9B,oBAAQ,IAAR,CAAa,KAAK,eAAlB,EAAmC,GAAnC,EAAwC,QAAxC;AACD,WAFD;AAGD;AACF,OAVe,CAAhB,EAUI,UAAU,GAAV,EAAe,MAAf,EAAuB;AACzB,YAAI,GAAJ,EAAS;AACP,iBAAO,IAAP,CAAY,GAAZ,EAAiB,MAAjB;AACD;AACF,OAdD;AAeD,KAjBD,MAiBO;AACL,SAAG,IAAH,EAAS,IAAT,EADK,CACU;AAChB;AACF;AACF,CA7DD;;AA+DA,SAAS,SAAT,CAAoB,eAApB,EAAqC;AACnC,SAAO,gBAAgB,QAAvB;AACD","file":"workflow.js","sourcesContent":["const lodash = require('lodash')\nconst async = require('async')\nconst logger = require('../util/log')(module)\n\nvar registeredEvents = {\n  'job.new': [],\n  'job.stop': [],\n  'job.retrieve.new': []\n}\n\nmodule.exports = function (emitter) {\n  emitter.on('workflow.baseEvents.job.new', baseEventsjobNew)\n  emitter.on('workflow.baseEvents.job.stop', baseEventsjobStop)\n  emitter.on('workflow.baseEvents.job.retrieve.new', baseEventsjobRetrieveNew)\n  emitter.on('workflow.registeredEvent.install', registeredEventInstall)\n  emitter.on('workflow.registeredEvent.next', registeredEventInstall)\n  emitter.on('workflow.registeredEvent.start', registeredEventStart)\n\n  function baseEventsjobNew (job, cb) {\n    registeredEventStart('job.new', job, cb)\n  }\n\n  function baseEventsjobStop (job, cb) {\n    registeredEventStart('job.stop', job, cb)\n  }\n\n  function baseEventsjobRetrieveNew (job, cb) {\n    registeredEventStart('job.retrieve.new', cb)\n  }\n\n  function registeredEventInstall ({domain, registeredEvent, priority}, cb) {\n    if (!registeredEvents.hasOwnProperty(domain)) {\n      registeredEvents[domain] = []\n    }\n    if (registeredEvents[domain].length === 0) {\n      var startJob = {\n        priority: 1\n      }\n      registeredEvents[domain].push(startJob)\n    }\n    registeredEvents[domain].push({\n      priority,\n      registeredEvent\n    })\n    registeredEvents[domain] = lodash.sortBy(registeredEvents[domain], eventSort)\n\n    cb(null, true)\n  }\n\n  function registeredEventStart (domain, job, cb) {\n    if (registeredEvents.hasOwnProperty(domain)) {\n      registeredEvents[domain] = lodash.sortBy(registeredEvents[domain], eventSort)\n      async.waterfall(registeredEvents[domain].map(function (item) {\n        if (item.priority === 1) {\n          return function (callback) {\n            callback(null, job)\n          }\n        } else {\n          return function (job, callback) {\n            emitter.emit(item.registeredEvent, job, callback)\n          }\n        }\n      }), function (err, result) {\n        if (err) {\n          logger.warn(err, result)\n        }\n      })\n    } else {\n      cb(null, null) // nothing registered\n    }\n  }\n}\n\nfunction eventSort (registeredEvent) {\n  return registeredEvent.priority\n}\n"]}